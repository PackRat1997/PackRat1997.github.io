MC.Leaderboard=new function(){var b=this;var a=this;this.selections={type:"global",period:"month",custom_leaderboard_id:0};this.level=null;this.user_callback=null;this.countdown=null;this.countdown_started=false;this.storage={};this.offsets={};this.current_limit=null;this.hide_top_load_button=false;this.hide_bottom_load_button=false;this.hide_gamecontainer=false;this.MD5=new function(){function e(x,v){var s=x[0],w=x[1],q=x[2],p=x[3];w=n(w=n(w=n(w=n(w=g(w=g(w=g(w=g(w=k(w=k(w=k(w=k(w=c(w=c(w=c(w=c(w,q=c(q,p=c(p,s=c(s,w,q,p,v[0],7,-680876936),w,q,v[1],12,-389564586),s,w,v[2],17,606105819),p,s,v[3],22,-1044525330),q=c(q,p=c(p,s=c(s,w,q,p,v[4],7,-176418897),w,q,v[5],12,1200080426),s,w,v[6],17,-1473231341),p,s,v[7],22,-45705983),q=c(q,p=c(p,s=c(s,w,q,p,v[8],7,1770035416),w,q,v[9],12,-1958414417),s,w,v[10],17,-42063),p,s,v[11],22,-1990404162),q=c(q,p=c(p,s=c(s,w,q,p,v[12],7,1804603682),w,q,v[13],12,-40341101),s,w,v[14],17,-1502002290),p,s,v[15],22,1236535329),q=k(q,p=k(p,s=k(s,w,q,p,v[1],5,-165796510),w,q,v[6],9,-1069501632),s,w,v[11],14,643717713),p,s,v[0],20,-373897302),q=k(q,p=k(p,s=k(s,w,q,p,v[5],5,-701558691),w,q,v[10],9,38016083),s,w,v[15],14,-660478335),p,s,v[4],20,-405537848),q=k(q,p=k(p,s=k(s,w,q,p,v[9],5,568446438),w,q,v[14],9,-1019803690),s,w,v[3],14,-187363961),p,s,v[8],20,1163531501),q=k(q,p=k(p,s=k(s,w,q,p,v[13],5,-1444681467),w,q,v[2],9,-51403784),s,w,v[7],14,1735328473),p,s,v[12],20,-1926607734),q=g(q,p=g(p,s=g(s,w,q,p,v[5],4,-378558),w,q,v[8],11,-2022574463),s,w,v[11],16,1839030562),p,s,v[14],23,-35309556),q=g(q,p=g(p,s=g(s,w,q,p,v[1],4,-1530992060),w,q,v[4],11,1272893353),s,w,v[7],16,-155497632),p,s,v[10],23,-1094730640),q=g(q,p=g(p,s=g(s,w,q,p,v[13],4,681279174),w,q,v[0],11,-358537222),s,w,v[3],16,-722521979),p,s,v[6],23,76029189),q=g(q,p=g(p,s=g(s,w,q,p,v[9],4,-640364487),w,q,v[12],11,-421815835),s,w,v[15],16,530742520),p,s,v[2],23,-995338651),q=n(q,p=n(p,s=n(s,w,q,p,v[0],6,-198630844),w,q,v[7],10,1126891415),s,w,v[14],15,-1416354905),p,s,v[5],21,-57434055),q=n(q,p=n(p,s=n(s,w,q,p,v[12],6,1700485571),w,q,v[3],10,-1894986606),s,w,v[10],15,-1051523),p,s,v[1],21,-2054922799),q=n(q,p=n(p,s=n(s,w,q,p,v[8],6,1873313359),w,q,v[15],10,-30611744),s,w,v[6],15,-1560198380),p,s,v[13],21,1309151649),q=n(q,p=n(p,s=n(s,w,q,p,v[4],6,-145523070),w,q,v[11],10,-1120210379),s,w,v[2],15,718787259),p,s,v[9],21,-343485551),x[0]=f(s,x[0]),x[1]=f(w,x[1]),x[2]=f(q,x[2]),x[3]=f(p,x[3])}function m(x,v,s,w,q,p){return v=f(f(v,x),f(w,p)),f(v<<q|v>>>32-q,s)}function c(y,v,s,w,q,p,x){return m(v&s|~v&w,y,v,q,p,x)}function k(y,v,s,w,q,p,x){return m(v&w|s&~w,y,v,q,p,x)}function g(y,v,s,w,q,p,x){return m(v^s^w,y,v,q,p,x)}function n(y,v,s,w,q,p,x){return m(s^(v|~w),y,v,q,p,x)}function l(v){txt="";var s=v.length,q=[1732584193,-271733879,-1732584194,271733878],u;for(u=64;u<=v.length;u+=64){e(q,o(v.substring(u-64,u)))}v=v.substring(u-64);var p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(u=0;u<v.length;u++){p[u>>2]|=v.charCodeAt(u)<<(u%4<<3)}if(p[u>>2]|=128<<(u%4<<3),u>55){for(e(q,p),u=0;u<16;u++){p[u]=0}}return p[14]=8*s,e(q,p),q}function o(s){var q=[],p;for(p=0;p<64;p+=4){q[p>>2]=s.charCodeAt(p)+(s.charCodeAt(p+1)<<8)+(s.charCodeAt(p+2)<<16)+(s.charCodeAt(p+3)<<24)}return q}var j="0123456789abcdef".split("");function h(s){for(var q="",p=0;p<4;p++){q+=j[s>>8*p+4&15]+j[s>>8*p&15]}return q}function d(q){for(var p=0;p<q.length;p++){q[p]=h(q[p])}return q.join("")}function i(p){return d(l(p))}function f(q,p){return q+p&4294967295}if("5d41402abc4b2a76b9719d911017c592"!=i("hello")){function f(s,q){var p=(65535&s)+(65535&q);return(s>>16)+(q>>16)+(p>>16)<<16|65535&p}}return{hash:i.bind(this)}};this.cipherTable={".":"m","-":"u","0":"y","1":"o","2":"w","3":"s","4":"r","5":"p","6":"t","7":"q","8":"v","9":"x","@":"z"};this.cipherScoreData=function(j,e,c){var d="M1n1"+j+"Cl1p"+e;var h=a.MD5.hash(d);var f="";var k=j+"@"+e+"@"+h+"@"+c;var m=k.toString().split("");var l=a.cipherTable;for(var g=0;g<m.length;g++){f+=(l[m[g]]?l[m[g]]:m[g])}return f};this.saveScore=function(f,c){try{if(MC.Proxy.state==2){MC.Proxy.postMessage("leaderboard_saveScore",f,{name:"leaderboard_saveScore",cb:c});return}if((typeof(f)==="string")||(typeof(f)==="number")||(typeof(f)==="object")){if((typeof(game_data)!="undefined")&&(typeof(game_data.game_id)==="number")){if(typeof(f)==="object"){f=a.cipherScoreData(game_data.game_id,f.score,f.level)}var e={game_id:game_data.game_id,data:f};if((typeof(challenge_data)!="undefined")&&(typeof(challenge_data.chuid)!="undefined")){e.chuid=challenge_data.chuid}$.ajax({url:"/games/highscore/save",type:"POST",dataType:"JSON",data:e,success:function(g){if(g.success===true){stats_manager.trackerLeaderboard("score_save")}if(typeof(c)==="function"){c(g)}else{throw ("Error: The callback provided is not a function")}if((typeof g.challenge_data!="undefined")&&(g.challenge_data)){MC.Challenge.updateChallengeBox(g.challenge_data)}},error:function(g){if(typeof(c)==="function"){c("Error: Error in ajax call, see JS console.")}else{throw ("Error: The callback provided is not a function")}console.log("Leaderboard.saveScore - Error: Error in ajax call",g)}})}else{throw ("Leaderboard.saveScore - Error: 	'game_data' or 'game_data.game_id' is not defined")}}else{throw ("Leaderboard.saveScore - Error: The data parameter has the wrong type")}}catch(d){if(typeof(c)==="function"){c("Error in save score: "+d)}else{throw ("Error: The callback provided is not a function")}throw (d)}};this.showAll=function(c){a.show(-1,c)};this.show=function(f,e){if(MC.Proxy.state==2){var c=function(g){if(!"status" in g){return}e(g.status);return g.status===2}.bind(this);MC.Proxy.postMessage("leaderboard_show",{level:f},{name:"leaderboard_show",cb:c});return}try{if(!a._hasValidLevelInfo()){$("#show-all-levels").hide()}else{$("#show-all-levels").show()}b.user_callback=e;if(typeof(f)==="number"){b.storage={};b.level=f;b.changeSelection(b.selections.type,b.selections.period,null,true);b._setupCustomLeaderboardLinks();if(a.hide_gamecontainer){$("#game-container").css("z-index",-1)}}else{throw ("Leaderboard.show - Error: The level parameter must be a number")}}catch(d){if(typeof(e)!=="function"){throw ("Leaderboard.show - Error: The callback provided is not a function")}b.hide()}};this._hasValidLevelInfo=function(){var c=MC.Modules.getConfig("leaderboard");if(!c){return false}if("max" in c||"level_info" in c){return true}return false};this.showLevels=function(n,m){var e=m||MC.Modules.getConfig("leaderboard");if(MC.Proxy.state==2){MC.Proxy.postMessage("leaderboard_show_levels",{config:e},{name:"leaderboard_show_levels",cb:n});return}if(!e){throw ("Missing leaderboard module config.")}var o=[];if("level_info" in e){o=e.level_info}else{if("max" in e&&e.max>0){var g=e.min||0,k=e.max;for(var h=0;h<=k;h++){o.push({level:h,name:"Level "+h})}}else{throw ("Missing leaderboard.level_info or leaderboard.max configs.")}}var d=$("#levels-list-content");d.html("");for(var h=0;h<o.length;h++){var c=o[h];var j=$("<div />").addClass("level-item level-"+c.level);j.attr("data-level",c.level);var l=$("<div />").addClass("level-number");l.html(c.level);var f=$("<div />").addClass("level-caption");f.html(c.name);j.append(l);j.append(f);d.append(j);j.on("click",function(i){var p=parseInt($(i.currentTarget).attr("data-level"));a.show(p,b.user_callback)})}$(".all-levels-section").show();$(".single-level-section").hide();$("#show-all-levels").hide();d.removeClass("loader")};this.changeSelection=function(e,f,c,d){if(b.level===null){throw ("MC.Leaderboard.show() must be called before MC.Leaderboard.changeSelection()")}if(typeof(d)==="undefined"&&d!=true){d=false}if(b.level==-1){this.showLevels()}else{$(".all-levels-section").hide();$(".single-level-section").show();if(typeof(e)!=="undefined"){if(e!==null){b.selections.type=e}}if(typeof(f)!=="undefined"){if(f!==null){b.selections.period=f}}if(typeof(c)!=="undefined"){if(c!==null){b.selections.custom_leaderboard_id=c}}b.offsets={};b.current_limit=null;b.hide_top_load_button=false;b.hide_bottom_load_button=false;$("#highscores-tab-content").html($("#loader-holder").html());if(b.selections.type==="top"){$(".countdown").html('Updated in: <span id="leaderboard-clearing-time"></span>');$("#leaderboard_period").hide();b._setupLeaderboardClearingTime("month")}else{$(".countdown").html('Reset in: <span id="leaderboard-clearing-time"></span>');$("#leaderboard_period").show();b._setupLeaderboardClearingTime(b.selections.period)}b._getData(b.level,b.selections.type,b.selections.period,b.user_callback,d,null)}$(".leaderboard-modal").fadeIn(300);$(".body-overlay").fadeIn(300)};this.hide=function(){$(".leaderboard-modal").fadeOut(300);$(".body-overlay").fadeOut(300);$("#game-container").css("z-index",0);if(typeof(b.user_callback)==="function"){b.user_callback(2)}};this.loadMore=function(c){if(c<0){b.offsets.above=c}if(c>0){b.offsets.below=c}b._getData(b.level,b.selections.type,b.selections.period,b.user_callback,false,c)};this.getRawLeaderboard=function(j,i,c){if(typeof(i)!=="function"){throw ("Error: The callback provided is not a function")}if(typeof(j)!=="number"){throw ("Error: The level param must be an integer")}var e="global";var g="month";var f=0;var d=null;if(typeof c!=="undefined"&&(typeof c==="object"||typeof c==="array")){if(typeof c[0]!=="undefined"&&c[0]!==null){e=c[0]}if(typeof c[1]!=="undefined"&&c[1]!==null){g=c[1]}if(typeof c[2]!=="undefined"&&c[2]!==null){f=c[2]}if(typeof c[3]!=="undefined"&&c[3]!==null){d=c[3]}}b.raw_data_user_callback=i;var h=function(l){var k=[];var m=l.leaderboard_data;for(row in m){m[row]=b._formatExternalScores(m[row])}k.data=m;k.message=l.message;k.success=l.success;b.raw_data_user_callback(k)};b._getData(j,e,g,h,true,f,"callback",d)};this._formatExternalScores=function(c){delete c.facebook_id;delete c.friend_button_html;delete c.avatar_override;if(typeof c.rank_img!=="undefined"){delete c.rank_img}return c};this.getUserHighscore=function(e,d){var c={game_id:game_data.game_id,level:e};$.ajax({url:"/games/highscore/get-user-highscore",type:"POST",dataType:"JSON",data:c,success:function(f){if(typeof(d)!=="function"){throw ("MC.Leaderboard.getUserHighscore - Error: provided callback is not a valid callback")}f.data=b._formatExternalScores(f.data);d(f)}})};this._populatePopup=function(F){var t=F.message;var C=JSON.parse(JSON.stringify(F.leaderboard_data));var n=F.game_data;if(F.offset===0){$("#highscores-tab-content").html("");b.offsets={above:0,below:0};b.current_limit=C.length}else{if(F.offset<0){C.reverse()}}for(row in C){if(C[row].rank==1){b.hide_top_load_button=true}var o=C[row];var A=$("<div />").addClass("ranking cell rank-"+C[row].rank);A.html(C[row].rank);if(C[row].nickname===null){continue}var m=$("<div />").addClass("user-img cell");m.append($("<img />").addClass("avatar").attr("src",C[row].avatar).attr("width","32").attr("height","32"));if(o.country){m.append($("<span />").addClass("country-flag").attr("style","background: url('/content/images/dynamic/flag_"+o.country.toLowerCase()+"_18.png');background-position:center;"))}if(C[row].rank==1){m.append($("<img />").addClass("crown").attr("src","/images/leaderboards/crown.png"))}var z=$("<div />").addClass("friend-button cell");z.html(C[row].friend_button_html);z.append('<div id="player_blob_'+C[row].user_id+'" class="toolbox bottom" style="margin-left: -40px; margin-top: 0px;width:100px;display: none;text-align: center;">Add Friend</div>');var D=$("<div />").addClass("user-name cell");if(C[row].score==="?"){var u=C[row].nickname+" <small>- You need to beat your highscore to show up here!</small>";D.attr("style","width:auto;")}else{var u=C[row].nickname}D.append($("<a />").attr("href","/user/"+C[row].user_id+"#t-lb-r"+C[row].rank).attr("target","__blank").html(u));var q=$("<div />").addClass("country-flag cell");if(o.country){q.append($("<img />").attr("src","/content/images/dynamic/flag_"+o.country.toLowerCase()+"_18.png"))}var v="";if(C[row].is_guest_score){var l=$("<a />").html("Signup to Save!").addClass("button hot action small").addClass("leaderboard-signup").attr("style","cursor:pointer;");$(".leaderboard-modal").off("click",".leaderboard-signup");$(".leaderboard-modal").on("click",".leaderboard-signup",function(){MC.login()});v=$("<div />").addClass("challenge cell").append(l)}else{if(!C[row].is_logged_in_user){var l=$("<a />").attr("href","?chuid="+C[row].user_id+"#t-lb-ch-r"+C[row].rank).html("Challenge").addClass("button hot action small");v=$("<div />").addClass("challenge cell").append(l)}else{if(C[row].score!=="?"){var f=$("<ul />").addClass("social-sites");var r={message:"I just got a highscore of "+C[row].score+" in "+n.name+". Challenge my score!",link:window.location.origin+"/games/"+n.game_url_key,link_picture:window.location.origin+"/"+n.big_icon.path,link_title:"Beat my score in "+n.name};var e=function(){MC.Share.postCustomMessage(function(G){var H=JSON.parse(G);if(H.success=="true"){$(".leaderboard-modal ul.social-sites").html('<div class="social-response">Posted</div>')}else{$(".leaderboard-modal ul.social-sites").html('<div class="social-response">Error</div>')}var I=setTimeout(function(){$(".leaderboard-modal ul.social-sites").html(b.social_tmp_store);clearTimeout(I)},3000)},JSON.stringify(r),"facebook");b.social_tmp_store=$(".leaderboard-modal ul.social-sites").html();$(".leaderboard-modal ul.social-sites").html('<img class="social-loader" src="'+static_path+'images/loading/waiting32.gif" />')};var c=$("<li />").append($("<a />").attr("href","#").addClass("mc-icon").addClass("facebook").html('<span class="screen-reader">Share your Score</span>'));$(".leaderboard-modal").off("click",".social-sites .facebook");$(".leaderboard-modal").on("click",".social-sites .facebook",e);var s="http://twitter.com/intent/tweet?text="+encodeURI(r.message)+"@miniclip&amp;url="+encodeURI(r.link)+"%3Futm_source%3Dgame-page%26utm_medium%3Dshare-button-twitter%26utm_campaign%3Dsocial-share";var k=$("<li />").append($("<a />").addClass("mc-icon").addClass("twitter").html('<span class="screen-reader">Tweet this score</span>').attr("href",s).attr("target","__blank"));var j="mailto:?subject="+encodeURI(r.link_title)+"&body="+encodeURI(r.message)+" : "+encodeURI(r.link);var x=$("<li />").append($("<a />").addClass("mc-icon").addClass("email").html('<span class="screen-reader">Share by email</span>').attr("href",j).attr("target","__blank"));var p="https://plus.google.com/share?url="+encodeURI(r.link);var g=$("<li />").append($("<a />").html('<span class="screen-reader">Share on Google+</span>').addClass("mc-icon").addClass("google-plus").attr("href",p).attr("target","__blank"));v=$("<div />").addClass("challenge cell").append(f.append(c).append(k).append(x).append(g))}}}if(C[row].score!=="?"){var y=$("<div />").addClass("score cell").html(C[row].score)}else{var y=""}var E=$("<div />").addClass("highscore-row").append(A).append(m).append(z).append(D).append(y).append(q).append(v);if(C[row].is_logged_in_user||C[row].is_guest_score){E.addClass("me")}var i=$("<div />").append(E);if(F.offset<0){$("#highscores-tab-content").prepend(i.html())}else{$("#highscores-tab-content").append(i.html())}}if(C.length===0&&F.offset===0){if(typeof(t)!=="undefined"&&t!==""){var B=t}else{var B="No submitted scores to show!"}$("#highscores-tab-content").html('<div class="notification info">'+B+"</div>")}else{$(".load-more").remove();if(F.offset>=0&&C.length!==8){b.hide_bottom_load_button=true}if(C[row].rank=="?"){b.hide_bottom_load_button=true}if(!b.hide_bottom_load_button){var d=$("<div />").addClass("highscore-row load-more").html('<a href="#" class="button greedy">Load More</a>');d.on("click","a",function(G){MC.Leaderboard.loadMore(b.offsets.below+b.current_limit);G.preventDefault()});$("#highscores-tab-content").append(d)}if(!b.hide_top_load_button){var h=$("<div />").addClass("highscore-row load-more").html('<span class="action-button blue aligned-leaderboard-big-button"><a href="#" class="button greedy">Load More</a></span>');h.on("click","a",function(G){MC.Leaderboard.loadMore(b.offsets.above-b.current_limit);G.preventDefault()});$("#highscores-tab-content").prepend(h);var w=$(".highscore-row:first-child").outerHeight();$("#highscores-tab-content").scrollTop(w)}}$(".highscore-row.me").hide();$(".highscore-row.me").delay(200).show("bounce",null,800);$(".challenge a").click(function(){if($(this).attr("href").split("#")[0]==window.location.search){window.location.reload()}});$(".challenge").click(function(){stats_manager.trackerChallenges("newChallenge")})};this._setupLeaderboardClearingTime=function(o,f){var m=new Date();var c=m.getMonth();var p=m.getFullYear();if(typeof f!=="undefined"){var n=f.split(" ");var i=n[0].split("-");var h=n[1].split(":");var r=Date.UTC(i[0],i[1],i[2],h[0],h[1],h[0])}else{if(o==="month"){var r=Date.UTC(p,c+1,1)}else{if(o==="week"){var k=new Date(p,c+1,0).getDate();var g=m.getDate();var j=m.getDay();var l=(g-j)+1;var e=l+7;if(e>k){c=c+1;e=(e-k)}var r=Date.UTC(p,c,e)}else{var r=Date.UTC(p,c+1,1)}}}var d=m.getTime();var q=Math.ceil((r-d)/1000);b.countdown=q;if(b.countdown_started===false){window.setInterval(function(){b.countdown--;var z=b.countdown;var y=Math.floor(z/86400);z-=y*86400;var t=Math.floor(z/3600)%24;var u=(t<10)?("0"+t):t;z-=t*3600;var v=Math.floor(z/60)%60;var w=(v<10)?("0"+v):v;z-=v*60;var x=z%60;var s=(x<10)?("0"+x):x;$("#leaderboard-clearing-time").html(y+" days "+u+":"+w+":"+s)},1000);b.countdown_started=true}};this._setupCustomLeaderboardLinks=function(){if(b.level<0){return}$.ajax({url:"/games/highscore/active-leaderboards",type:"POST",dataType:"JSON",data:{game_id:game_data.game_id,level:b.level},success:function(c){if(typeof c.success==="undefined"){throw ("Leaderboard._setupCustomLeaderboardLinks - Error: Can't get custom leaderboards")}if(!c.success){throw ("Leaderboard._setupCustomLeaderboardLinks - Error: "+c.message)}$("#custom_leaderboard_tabs").html("");for(index in c.active_leaderboards){if(c.active_leaderboards[index].is_default==="0"){var d=$("<span />").addClass("action-button tab");d.data("nav","custom").data("leaderboard-id",c.active_leaderboards[index].leaderboard_id);var e=$("<a />").attr("href","#").html(c.active_leaderboards[index].event_name);$("#custom_leaderboard_tabs").append(d.html(e))}}},error:function(c){console.log("Leaderboard._setupCustomLeaderboardLinks - Error: Error in ajax call",c)}})};this._getData=function(c,i,h,k,d,f,l,e){var j=game_data.game_id+i+c+h+b.selections.custom_leaderboard_id+f+":"+e;if(i==="custom"){g.custom_leaderboard_id=b.selections.custom_leaderboard_id}if(typeof f==="undefined"||f===null){f=0}if(typeof l==="undefined"){l="local"}var g={game_id:game_data.game_id,type:i,level:c,period:h,offset:f};if(typeof e!=="undefined"||typeof e!==null){g.limit=e}if(typeof(b.storage[j])==="undefined"){$.ajax({url:"/games/highscore/leaderboard",type:"POST",dataType:"JSON",data:g,success:function(m){try{if(typeof m.success==="undefined"){throw ("Leaderboard._getData - Error: Wrongly formatted response")}if(!m.success){throw ("Leaderboard._getData - Error: "+m.message)}if(typeof(k)!=="function"){throw ("Leaderboard._getData - Error: The callback provided is not a function")}b.storage[j]=m;if(l==="local"){b._populatePopup(m);if(d===true){k(1)}}else{if(l==="callback"){k(m)}else{throw ("Leaderboard._getData - Error: Unknown return_type")}}}catch(n){if(l==="local"){b.hide()}throw (n)}},error:function(m){if(l==="local"){b.hide()}console.log("Leaderboard._getData - Error: Error in ajax call",m)}})}else{if(typeof(k)!=="function"){throw ("Leaderboard._getData - Error: The callback provided is not a function")}if(l==="local"){b._populatePopup(b.storage[j]);if(d===true){b.user_callback(1)}}else{if(l==="callback"){k(b.storage[j])}else{throw ("Leaderboard._getData - Error: Unknown return_type")}}}};this.setOption=function(d,c){if(d in this){this[d]=c}};this.getOption=function(c){if(c in this){return this[c]}return null};return{saveScore:this.saveScore,show:this.show,hide:this.hide,changeSelection:this.changeSelection,showAll:this.showAll,showLevels:this.showLevels,loadMore:this.loadMore,getRawLeaderboard:this.getRawLeaderboard,getUserHighscore:this.getUserHighscore,setOption:this.setOption,getOption:this.getOption}};